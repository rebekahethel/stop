{% extends "base.html" %}

{% block content %}
{% if sala.data_inicio %}
<div class="container mt-5">
    <h1>Sala: {{ sala.id }}</h1>
    {% else %}
    <div class="container mt-5">
        <h1>Sala: {{ sala.id }}</h1>
        <p>Aguardando início do jogo...</p>
        {% endif %}

        {% if sala.data_inicio %}
        <div class="row">
            <div class="col-12 justify-content-center text-center mb-3">
                <span class="me-4">Número da rodada: {{ rodada.numero }} </span>

                <span class="ms-4">Letra sorteada: {{ rodada.letra.letra }}</span>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <!-- Coluna de jogadores -->
            <div class="col-md-2 col-lg-2">
                <h5>Jogadores</h5>
                <ul id="lista-jogadores" class="list-unstyled"></ul>
            </div>

            <div class="col-md-7 col-lg-7">
                {% if sala.finalizado %}
                <div class="alert alert-info text-center" role="alert">
                    Jogo finalizado! Obrigado por jogar.
                    Veja o ranking abaixo:
                    <a href="{{ url_for('resultado', sala_id=sala.id) }}" class="btn btn-primary btn-sm ms-2">Ver
                        Ranking</a>
                </div>

                {% elif sala.data_inicio %}

                <div class="row">
                    <input type="hidden" name="sala_id" value="{{ sala.id }}">
                    {% for tema in temas %}
                    <div class="col-4">
                        <label for="{{ tema.id }}">{{ tema.nome }}</label>
                        <input type="text" class="mb-2 input-response" id="{{ tema.id }}" name="{{ tema.id }}" required>
                    </div>
                    {% endfor %}
                </div>
                <div class="row align-items-center justify-content-center">
                    <button onclick="stop()" class="btn btn-danger mt-4 col-3">STOP</button>
                </div>


                {% else %}
                <div class="input-group">
                    <button class="btn btn-primary" onclick="iniciar_jogo()">Iniciar Jogo</button>
                </div>
                {% endif %}
            </div>

            <div class="col-md-3 col-lg-3 d-flex flex-column" style="background-color: lightsalmon; height: 60vh;">

                <div class="row">
                    <h2>Chat</h2>
                </div>

                <!-- Lista de mensagens -->
                <ul id="chat" class="flex-grow-1 overflow-auto border p-2 mb-2"></ul>

                <!-- Inputs sempre no rodapé -->
                <div class="mt-auto">
                    <input type="text" id="sala_id" value="{{ sala.id }}" hidden>
                    <input type="text" id="jogador_id" value="{{ current_user.id }}" hidden>

                    <input type="text" id="sala" value="{{ sala.id }}" hidden>
                    <input type="text" id="usuario" value="{{ current_user.nome }}" hidden>
                    <div class="input-group">
                        <input id="msg" class="form-control" placeholder="Digite sua mensagem...">
                        <button type="submit" class="btn btn-danger" onclick="enviar()">Enviar</button>
                    </div>
                </div>
            </div>

            <div class="container text-center">
                <h1>⏳ Tempo Restante</h1>

                <!-- Elemento do timer -->
                <div id="timer">Carregando...</div>

                <!-- Barra de progresso -->
                <div class="progress w-75 mx-auto">
                    <div id="progress-bar" class="progress-bar bg-success" style="width: 100%;"></div>
                </div>
            </div>

            <script>
                const socket = io();

                function entrar() {
                    const usuario = document.getElementById("usuario").value;
                    const sala = document.getElementById("sala").value;
                    socket.emit("entrar_sala", { usuario, sala });
                }

                function sair() {
                    const usuario = document.getElementById("usuario").value;
                    const sala = document.getElementById("sala").value;
                    socket.emit("sair_sala", { usuario, sala });
                }

                function iniciar_jogo() {
                    const sala = document.getElementById("sala").value;
                    socket.emit("iniciar_jogo", { usuario, sala });

                }

                socket.on("atualizar_jogadores", (jogadores) => {
                    const lista = document.getElementById("lista-jogadores");
                    lista.innerHTML = "";
                    jogadores.forEach(j => {
                        const li = document.createElement("li");
                        li.classList.add("d-flex", "align-items-center", "mb-2");
                        li.innerHTML = `
                <img src="/static/avatar.jpg" alt="avatar" width="40" height="40"
                    class="rounded-circle me-2">
                <span>${j}</span>
            `;
                        lista.appendChild(li);
                    });
                });


                socket.on("jogo_iniciado", (msg) => {
                    location.reload();
                    console.log("Jogo iniciado!");
                    //emit("jogo_iniciado", room=sala_id, current_timestamp=rodada[0].data_inicio.strftime('%Y-%m-%d %H:%M:%S'))

                });



                socket.on("rodada_atualizada", (msg) => {
                    location.reload();
                    console.log("Rodada Atualizada!");

                });




                function enviar() {
                    const usuario = document.getElementById("usuario").value;
                    const sala = document.getElementById("sala").value;
                    const msg = document.getElementById("msg").value;
                    socket.emit("mensagem_sala", { usuario, sala, msg });
                    document.getElementById("msg").value = "";
                }



                function stop() {
                    const jogador_id = document.getElementById("jogador_id").value;
                    const sala_id = document.getElementById("sala_id").value;
                    const usuario = document.getElementById("usuario").value;
                    socket.emit("stop", { jogador_id, sala_id, usuario });

                }

                // Função que coleta e envia respostas
                function enviarRespostas() {

                    const jogador_id = document.getElementById("jogador_id").value;
                    const sala_id = document.getElementById("sala_id").value;
                    const usuario = document.getElementById("usuario").value;
                    // Pega todos os inputs de resposta
                    const respostas = {};
                    document.querySelectorAll(".input-response").forEach(input => {
                        respostas[input.name] = input.value.trim(); // usa o name (tema_id) como chave
                    });

                    // Envia via socket
                    socket.emit("stop_respostas", { jogador_id, sala_id, respostas, usuario });
                    // Opcional: desabilitar inputs após enviar
                    document.querySelectorAll(".input-response").forEach(input => {
                        input.disabled = true;
                    });
                }

                // Quando receber o STOP geral, todos os jogadores enviam também
                socket.on("stop_geral", (data) => {
                    console.log("STOP acionado por:", data.usuario);
                    enviarRespostas();
                });


                socket.on("mensagem", (msg) => {
                    const li = document.createElement("li");
                    li.textContent = msg;
                    document.getElementById("chat").appendChild(li);
                });


                function iniciarContagem(dataInicioUnix, tempoTotalSegundos) {
                    tempoTotalSegundos = parseInt(tempoTotalSegundos, 10);
                    if (isNaN(tempoTotalSegundos)) tempoTotalSegundos = 60;

                    const timerElement = document.getElementById('timer');
                    const progressBar = document.getElementById('progress-bar');

                    const fim = (parseInt(dataInicioUnix, 10) * 1000) + tempoTotalSegundos * 1000;

                    const countdown = setInterval(() => {
                        let restante = Math.max(0, Math.floor((fim - Date.now()) / 1000));

                        timerElement.textContent = restante + "s";
                        progressBar.style.width = (restante / tempoTotalSegundos * 100) + "%";

                        timerElement.classList.toggle("time-warning", restante <= 10 && restante > 5);
                        timerElement.classList.toggle("time-danger", restante <= 5);

                        if (restante === 0) {
                            clearInterval(countdown);
                            timerElement.textContent = "⏰ Tempo esgotado!";
                            progressBar.classList.remove("bg-success", "bg-warning", "bg-danger");
                            progressBar.classList.add("bg-secondary");
                        }
                    }, 1000);
                }

                document.addEventListener("DOMContentLoaded", () => {
            
                    const agora = Math.floor(Date.now() / 1000);
                    iniciarContagem(agora, 20); // timer de 20 segundos
                     
                   
                });

                entrar();
            </script>
            {% endblock %}